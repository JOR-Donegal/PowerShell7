# Background 
To do these exercises, you will need access to some Windows VMs. 
If you are completing this on Azure Labs, you need a VM with Hyper-V.
If you are working on campus, or using a home machine with VMWare Workstation, you should be able to complete these exercises.
On a real project, I will install remote tools of some kind on my jump server or a dedicated management VM.

## Remoting
To connect to another computer using PowerShell, I use the following.
```
$REMOTE_SERVER = 'server-1'

# Connect to server-1
Enter-PSSession $REMOTE_SERVER
# Do stuff on the remote server
Exit-PSSession
```
This may be a bit more complex! 
There may be firewall, policy issues and permissions you need to sort on  a per case basis.

# DC Build
The fist thing I do when creating a new environment is to create the domain controllers. I spin up a Windows Server with a GUI as DC1 and run the following script to install the correct software.
```
Install-WindowsFeature -name AD-Domain-Services â€“IncludeManagementTools

Import-Module ADDSDeployment
Install-ADDSForest `
-CreateDnsDelegation:$false `
-DatabasePath "C:\Windows\NTDS" `
-DomainMode "WinThreshold" `
-DomainName "ads.kmn.ie" `
-DomainNetbiosName "ads" `
-ForestMode "WinThreshold" `
-InstallDns:$true `
-LogPath "C:\Windows\NTDS" `
-NoRebootOnCompletion:$false `
-SysvolPath "C:\Windows\SYSVOL" `
-Force:$true

Shutdown /r /t 0
```
Next I need to configure the domain controller. Note I use variables where possible, it reduce the risk of human error.
```
$SERVERNAME = "dc1"
$FOREST = "ads.kmn.ie"
$DNSNAME = $SERVERNAME + "." + $FOREST

# Set the IP address for the DC
Rename-Computer -NewName $SERVERNAME
Get-NetIPAddress
New-NetIPAddress -InterfaceIndex 16 -IPAddress 172.27.6.11 -PrefixLength 24 -DefaultGateway 172.27.6.20
Restart-Computer

# Configure AD, DNS
Install-ADDSForest -DomainName $FOREST
Install-WindowsFeature DHCP -IncludeManagementTools

# Configure DHCP, add a single scope
Add-DhcpServerInDC -DnsName $DNSNAME -IPAddress 172.27.6.11
Add-DhcpServerv4Scope -Name InfraServers -StartRange 172.27.6.150 -EndRange 172.27.6.199 -SubnetMask 255.255.255.0

# Set time to sync'h with a local NTP server.
w32tm /config /manualpeerlist:172.27.15.254 /syncfromflags:manual /update
```
We always have a second DC, in this case I use Windows Core and the following script.
```
$SERVERNAME = "dc2"
$FOREST = "ads.kmn.ie"
$DNSNAME = $SERVERNAME + "." + $FOREST

# Set the IP address for the DC
Rename-Computer -NewName $SERVERNAME
Get-NetIPAddress
New-NetIPAddress -InterfaceIndex 9 -IPAddress 172.27.6.12 -PrefixLength 24 -DefaultGateway 172.27.6.20
Set-DnsClientServerAddress -InterfaceIndex 9 -ServerAddresses 172.27.6.11
Restart-Computer

# Join the existing Domain
Add-Computer -DomainName $FOREST -Restart

# Install software
Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools

# Add this as a second DC
Install-ADDSDomainController -DomainName $FOREST -InstallDns:$true -Credential (Get-Credential "janus\administrator")

# Configure DHCP
Install-WindowsFeature DHCP -IncludeManagementTools
Add-DhcpServerInDC -DnsName $DNSNAME -IPAddress 172.27.6.12
```
I verify each DNS using Resolve-Dnsname
Fig 16 is for a different system from that configured above.
<figure>
<img src = "https://jor-donegal.github.io/PowerShell7/images/fig16.jpg">
<figcaption>Fig 16. Typical output.</figcaption>
</figure>

## DHCP
Sometimes I will create and configure DHCP scopes using automation.
```
Add-DhcpServerv4Scope -name "ISP" -StartRange 10.1.1.100 -EndRange 10.1.1.254 -SubnetMask 255.255.255.0 -State Active
Add-DhcpServerv4ExclusionRange -ScopeID 10.1.1.0 -StartRange 10.1.1.200 -EndRange 10.1.1.254
Set-DhcpServerv4OptionValue -OptionID 3 -Value 10.1.1.1 -ScopeID 10.1.1.0 -ComputerName dc1.ads.electric-petrol.ie
```

# Demote a DC
If I'm deprecating a DC, I need to do so cleanly. Its really messy to remove a DC from the directory if it is no longer bootable.
```
<#
Remote server setup script.
Demotes a DC
Run one line at a time, under supervision!
#>
$REMOTE_SERVER = 'server-1'

# Connect to server-1
Enter-PSSession $REMOTE_SERVER

Import-Module ADDSDeployment
Uninstall-ADDSDomainController -DemoteOperationMasterRole:$true -ForceRemoval:$true -Force:$true

Exit-PSSession
```
I may then get the computer to leave the domain.
```
Remove-Computer -UnjoinDomaincredential ads\Administrator -PassThru -Verbose -Force
```
